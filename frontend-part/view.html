<!DOCTYPE html>
<html>
<head>
    <title id="pageTitle">View Blog</title>
    <link rel="stylesheet" href="view.css"> 
    <link href="https://fonts.googleapis.com/css2?family=Merriweather:wght@400;700&family=Poppins:wght@400;600;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css"> 
</head>
<body>

<header id="site-header">
    <div class="header-content">
        <h1 class="site-title">WriteFlow<span class="logo-accent">.</span></h1>
    </div>
</header>

<div class="page-wrapper">
    <div class="header-nav">
        <a href="myblogs.html" class="nav-btn primary-btn"><i class="fas fa-arrow-left"></i> My Posts</a>
        <button id="tocToggle" class="nav-btn toc-toggle"><i class="fas fa-list"></i> Contents</button>
        <a href="blog.html" class="nav-btn secondary-btn">Public Feed <i class="fas fa-globe"></i></a>
    </div>

    <div class="glass-container">
        
        <h1 id="blogTitle"></h1>
        
        <div class="metadata">
            <span class="meta-item author-line">
                <i class="fas fa-user-circle"></i> By: <span id="blogAuthor"></span>
            </span>
            <span class="meta-separator">|</span>
            <span class="meta-item read-time-line">
                <i class="fas fa-clock"></i> <b><span id="readTime"></span></b>
            </span>
        </div>

        <div id="blogImageContainer">
            </div>
        
        <div class="main-layout">
            <div id="tocContainer" class="toc-card sticky-toc">
                <h3><i class="fas fa-list-alt"></i> Table of Contents</h3>
                <ul id="tocList">
                    </ul>
            </div>

            <div id="blogContent" class="main-content">
                </div>
        </div>
        
        <hr class="section-divider">

        <div id="authorBio" class="author-bio-card">
            <div class="author-header">
                <div class="avatar-placeholder">
                    <span id="avatarInitials">A</span>
                </div>
                <h4>About: <span id="authorNameFooter"></span></h4>
            </div>
            <p><small>This post was written by <span id="authorNameTiny"></span>, a valuable contributor to our blog application.</small></p>
            <a href="blog.html" class="more-blogs-link"><i class="fas fa-arrow-right"></i> More blogs by this author</a>
        </div>
    </div>
</div>

<script>
// --- UTILITY FUNCTIONS (UNCHANGED) ---
function calculateReadingTime(content) {
    const wordsPerMinute = 200;
    const wordCount = content.trim().split(/\s+/).length;
    const minutes = Math.ceil(wordCount / wordsPerMinute);
    return minutes;
}

function getAuthorName(username) {
    // Simple logic to get initials for the avatar
    if (!username) return 'NA';
    const parts = username.split(' ');
    if (parts.length > 1) {
        return parts[0].charAt(0).toUpperCase() + parts[parts.length - 1].charAt(0).toUpperCase();
    }
    return username.substring(0, 2).toUpperCase();
}


// --- MAIN FETCH LOGIC ---
const id = new URLSearchParams(location.search).get("id");

if (!id) {
    document.body.innerHTML = "<h2>Error: Blog ID not found.</h2>";
} else {
    fetch("http://localhost:8080/blog/" + id)
        .then(r => r.json())
        .then(b => {
            // Populate Title and Metadata
            document.getElementById("pageTitle").innerText = b.title;
            document.getElementById("blogTitle").innerText = b.title;
            const authorName = b.username || "Unknown Author";
            document.getElementById("blogAuthor").innerText = authorName;

            // Populate Author Bio Footer
            document.getElementById("authorNameFooter").innerText = authorName;
            document.getElementById("authorNameTiny").innerText = authorName;
            document.getElementById("avatarInitials").innerText = getAuthorName(authorName);


            const readingMinutes = calculateReadingTime(b.content);
            document.getElementById("readTime").innerText = `${readingMinutes} min read`;
            
            // 3. Image Display
            if (b.imageUrl) {
                document.getElementById("blogImageContainer").innerHTML = `
                    <div class="image-wrapper">
                        <img src="${b.imageUrl}" alt="${b.title}" class="featured-image">
                        <div class="image-shadow-overlay"></div>
                    </div>
                `;
            }

            // --- TOC and Content Processing (UNCHANGED LOGIC) ---
            let content = b.content;
            let tocHTML = '';
            let headingCount = 0;
            const lines = content.split('\n');
            let processedLines = [];

            lines.forEach(line => {
                const trimmedLine = line.trim();
                if (trimmedLine.length > 0) {
                    if (trimmedLine.length < 50 && trimmedLine === trimmedLine.toUpperCase() && trimmedLine.indexOf(' ') > -1) {
                        headingCount++;
                        const anchorName = `section-${headingCount}`;
                        
                        tocHTML += `<li><a href="#${anchorName}" class="toc-link">${trimmedLine}</a></li>`;
                        processedLines.push(`<a name="${anchorName}"></a><h3 class="section-heading">${trimmedLine}</h3>`); 
                    } else {
                        processedLines.push(`<p>${trimmedLine}</p>`);
                    }
                }
            });

            document.getElementById("blogContent").innerHTML = processedLines.join('');
            document.getElementById("tocList").innerHTML = tocHTML;
            
            if (headingCount === 0) {
                document.getElementById("tocContainer").style.display = 'none'; 
                document.getElementById("tocToggle").style.display = 'none';
            }

            // --- INTERACTIVE SCRIPTS ---

            // Smooth Scroll for TOC links
            document.querySelectorAll('.toc-link').forEach(anchor => {
                anchor.addEventListener('click', function (e) {
                    e.preventDefault();
                    document.querySelector(this.getAttribute('href')).scrollIntoView({
                        behavior: 'smooth'
                    });
                });
            });

            // TOC Toggle for Mobile
            document.getElementById('tocToggle').addEventListener('click', function() {
                const toc = document.getElementById('tocContainer');
                const isHidden = toc.classList.contains('hidden-mobile');
                if (isHidden) {
                    toc.classList.remove('hidden-mobile');
                    this.innerHTML = '<i class="fas fa-times"></i> Close Contents';
                } else {
                    toc.classList.add('hidden-mobile');
                    this.innerHTML = '<i class="fas fa-list"></i> Contents';
                }
            });

        })
        .catch(err => {
            document.getElementById("blogTitle").innerText = "Error loading blog.";
            document.getElementById("blogContent").innerHTML = "<p class='error-message'>Could not fetch blog content. Please check the ID and server connection.</p>";
            console.error(err);
        });
}
</script>

</body>
</html>