<!DOCTYPE html>
<html>
<head>
Â  Â  <title>Edit Blog</title>
Â  Â  <link rel="stylesheet" href="edit.css"> <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap" rel="stylesheet">
Â  Â  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
</head>
<body>

<div id="page-wrapper">
Â  Â  
Â  Â  <h1 id="page-title">ðŸŒŸ WriteFlow â€“ Edit Blog</h1> 

Â  Â  <div id="blog-card">
Â  Â  Â  Â  
Â  Â  Â  Â  <h2 class="card-header">Edit Your Existing Blog Post</h2>
Â  Â  Â  Â  
Â  Â  Â  Â  <div class="form-grid">
Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  <div class="main-content-section">
Â  Â  Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  Â  Â  <input id="title" placeholder="Blog Title (Max 80 characters)">
Â  Â  Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  Â  Â  <textarea id="content" placeholder="Write your content here..."></textarea>
Â  Â  Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  Â  Â  <div class="actions-footer">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button onclick="save()" class="update-btn">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <i class="fas fa-check-circle"></i> Update Blog
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </button>

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <a href="myblogs.html" class="cancel-link">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <i class="fas fa-arrow-left"></i> Cancel and Go Back
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </a>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  Â  <div class="image-upload-section">
Â  Â  Â  Â  Â  Â  Â  Â  <label for="imageFile" class="image-upload-box" id="upload-area">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div id="upload-box-placeholder">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <i class="fas fa-cloud-upload-alt"></i>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <p>Click to replace image or drag & drop</p>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <p class="recommended-size">1200 Ã— 800 recommended</p>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <p class="current-image-status">Current Image Loaded</p>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <input type="file" id="imageFile" accept="image/*" style="display: none;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <img id="image-preview" src="#" alt="Image Preview" style="display: none;">
Â  Â  Â  Â  Â  Â  Â  Â  </label>
Â  Â  Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  Â  Â  <p id="msg" class="validation-msg"></p>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  </div>
Â  Â  </div>
</div>

<script>
// --- CRITICAL SECURITY CHECK (P3) ---
const loggedInUserId = localStorage.getItem("userId");
if (!loggedInUserId) {
    alert("You must be logged in to edit a blog post.");
    window.location.href = "login.html"; 
}
// --- END SECURITY CHECK ---

// Global variables to manage the image update flow
let base64Image = ""; // Holds the new Base64 string if a new file is chosen
let initialImageUrl = ""; // Holds the existing URL fetched from the server

const id = new URLSearchParams(location.search).get("id");
const msgElement = document.getElementById("msg");

// --- INITIAL FETCH TO POPULATE FIELDS AND IMAGE PREVIEW ---
fetch("http://localhost:8080/blog/" + id)
.then(r => r.json())
.then(b => {
    // âš ï¸ Secondary Security Check: Ensure the logged-in user is the author of this post
    if (b.userId !== loggedInUserId) {
        alert("Authorization Error: You can only edit your own posts.");
        // Redirect to the user's own blog list or the public feed
        window.location.href = "myblogs.html"; 
        return; 
    }

Â  Â  title.value = b.title;
Â  Â  content.value = b.content;

Â  Â  // 3. Show current image in preview
Â  Â  if (b.imageUrl) {
Â  Â  Â  Â  initialImageUrl = b.imageUrl;
Â  Â  Â  Â  const previewImg = document.getElementById('image-preview');
Â  Â  Â  Â  const placeholder = document.getElementById('upload-box-placeholder');
Â  Â  Â  Â  
Â  Â  Â  Â  previewImg.src = initialImageUrl;
Â  Â  Â  Â  previewImg.style.display = 'block';
Â  Â  Â  Â  placeholder.style.display = 'none'; 
Â  Â  }
});

// --- FILE UPLOAD LISTENER (Base64 Conversion) ---
document.getElementById('imageFile').addEventListener('change', function(e) {
Â  Â  const file = e.target.files[0];
Â  Â  const previewImg = document.getElementById('image-preview');
Â  Â  const placeholder = document.getElementById('upload-box-placeholder');
Â  Â  
Â  Â  if (file) {
Â  Â  Â  Â  msgElement.innerText = ""; // Clear previous error
Â  Â  Â  Â  
Â  Â  Â  Â  const reader = new FileReader();
Â  Â  Â  Â  reader.onloadend = function() {
Â  Â  Â  Â  Â  Â  // New image chosen: overwrite base64Image
Â  Â  Â  Â  Â  Â  base64Image = reader.result;
Â  Â  Â  Â  Â  Â  // Update preview
Â  Â  Â  Â  Â  Â  previewImg.src = base64Image;
Â  Â  Â  Â  Â  Â  previewImg.style.display = 'block';
Â  Â  Â  Â  Â  Â  placeholder.style.display = 'none'; 
Â  Â  Â  Â  Â  Â  console.log("New image successfully converted to Base64.");
Â  Â  Â  Â  }
Â  Â  Â  Â  reader.readAsDataURL(file); // Starts the conversion process
Â  Â  } else {
Â  Â  Â  Â  // Reset if selection is canceled, but keep initial image if present
Â  Â  Â  Â  base64Image = "";
Â  Â  Â  Â  if (!initialImageUrl) {
Â  Â  Â  Â  Â  Â  previewImg.style.display = 'none';
Â  Â  Â  Â  Â  Â  placeholder.style.display = 'flex';
Â  Â  Â  Â  }
Â  Â  }
});

// --- SAVE (UPDATE) FUNCTION ---
function save(){
Â  Â  // 5. Validation
Â  Â  if (title.value.trim() === "" || content.value.trim() === "") {
Â  Â  Â  Â  msgElement.innerText = "Title and Content cannot be empty.";
Â  Â  Â  Â  msgElement.style.color = "var(--danger-color)";
Â  Â  Â  Â  return;
Â  Â  }

Â  Â  // Determine the final image URL: (New Base64) OR (Existing URL)
Â  Â  const finalImageUrl = base64Image || initialImageUrl;

Â  Â  if (finalImageUrl === "") {
Â  Â  Â  Â  msgElement.innerText = "Please upload a featured image.";
Â  Â  Â  Â  msgElement.style.color = "var(--danger-color)";
Â  Â  Â  Â  return;
Â  Â  }

Â  Â  fetch("http://localhost:8080/blog/update/"+id,{
Â  Â  Â  Â  method:"PUT",
Â  Â  Â  Â  headers:{"Content-Type":"application/json"},
Â  Â  Â  Â  body:JSON.stringify({
Â  Â  Â  Â  Â  Â  title:title.value,
Â  Â  Â  Â  Â  Â  // Send the new Base64 or the old URL
Â  Â  Â  Â  Â  Â  imageUrl: finalImageUrl, 
Â  Â  Â  Â  Â  Â  content:content.value,
Â  Â  Â  Â  Â  Â  userId:localStorage.getItem("userId"),
Â  Â  Â  Â  Â  Â  username:localStorage.getItem("username")
Â  Â  Â  Â  })
Â  Â  })
Â  Â  .then(r => r.text())
Â  Â  .then(responseMsg => {
Â  Â  Â  Â  // 5. Validation & Feedback
Â  Â  Â  Â  if (responseMsg.toLowerCase().includes("success")) {
Â  Â  Â  Â  Â  Â  Â msgElement.style.color = "var(--primary-color)";
Â  Â  Â  Â  Â  Â  Â msgElement.innerText = "Update successful! Redirecting...";
Â  Â  Â  Â  Â  Â  Â setTimeout(()=>location.href="myblogs.html",1000);
Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â msgElement.style.color = "var(--danger-color)";
Â  Â  Â  Â  Â  Â  Â msgElement.innerText = responseMsg || "Update failed.";
Â  Â  Â  Â  }
Â  Â  });
}
</script>

</body>
</html>